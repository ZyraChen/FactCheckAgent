# 系统架构说明

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          输入层                                   │
│  ┌──────────┐     ┌────────────┐     ┌──────────────┐          │
│  │  Claim   │     │ Config.py  │     │  Dataset     │          │
│  │  主张    │     │ API Keys   │     │  JSON文件    │          │
│  └──────────┘     └────────────┘     └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                       主控制器(main.py)                          │
│  ┌──────────────────────────────────────────────────┐           │
│  │  async def run_debate_system(claim, rounds=3):  │           │
│  │    1. 初始化组件(Pro/Con/Judge/Search/LLM)      │           │
│  │    2. 创建共享数据结构(证据池+论辩图)          │           │
│  │    3. 循环运行N轮辩论                           │           │
│  │    4. Judge最终判决                             │           │
│  │    5. 保存结果                                  │           │
│  └──────────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        辩论层(每轮)                              │
│                                                                   │
│  ┌───────────────┐              ┌───────────────┐               │
│  │  Pro Agent    │              │  Con Agent    │               │
│  │  (支持方)     │              │  (反对方)     │               │
│  └───────┬───────┘              └───────┬───────┘               │
│          │                              │                        │
│          ├─ 1.生成搜索词                ├─ 1.生成搜索词        │
│          ├─ 2.搜索(Jina)                ├─ 2.搜索(Jina)        │
│          ├─ 3.筛选证据                  ├─ 3.筛选证据          │
│          └─ 4.构建论证                  └─ 4.构建论证          │
│                    ↓                          ↓                  │
│              ┌──────────────────────────────────┐               │
│              │     共享数据结构(实时更新)       │               │
│              │                                  │               │
│              │  ┌────────────────────────┐     │               │
│              │  │   证据池(EvidencePool)  │     │               │
│              │  │  - 双方检索的所有证据   │     │               │
│              │  │  - 自动去重             │     │               │
│              │  │  - 可信度评估           │     │               │
│              │  └────────────────────────┘     │               │
│              │                                  │               │
│              │  ┌────────────────────────┐     │               │
│              │  │ 论辩图(ArgumentGraph)   │     │               │
│              │  │  - 论证节点(带优先级)   │     │               │
│              │  │  - 攻击边(高→低)       │     │               │
│              │  │  - 动态增量构建         │     │               │
│              │  └────────────────────────┘     │               │
│              └──────────────────────────────────┘               │
│                              ↓                                   │
│              ┌──────────────────────────────┐                   │
│              │    攻击关系更新(每轮后)      │                   │
│              │  - 检测新节点vs已有节点      │                   │
│              │  - 仅允许高优先级→低优先级   │                   │
│              │  - 添加攻击边到论辩图        │                   │
│              └──────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        判决层(Judge Agent)                       │
│                                                                   │
│  ┌──────────────────────────────────────────────────┐           │
│  │  1. 计算Grounded Extension                       │           │
│  │     - 输入: 完整的论辩图                        │           │
│  │     - 算法: 形式化语义(semantics.py)            │           │
│  │     - 输出: 可接受论证集合                       │           │
│  │                                                  │           │
│  │  2. 评估双方强度                                │           │
│  │     - Pro强度 = 平均优先级 × 接受率            │           │
│  │     - Con强度 = 平均优先级 × 接受率            │           │
│  │                                                  │           │
│  │  3. 生成判决                                    │           │
│  │     - Decision: Supported/Refuted/NEI          │           │
│  │     - Confidence: 基于强度差异                 │           │
│  │     - Reasoning: LLM生成可解释文本             │           │
│  │     - Key Evidence: 关键证据溯源               │           │
│  └──────────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                          输出层                                   │
│                                                                   │
│  ┌───────────────────┐  ┌───────────────────┐                  │
│  │ verdict.json      │  │ argumentation     │                  │
│  │ - 判决结果        │  │   _graph.json     │                  │
│  │ - 置信度          │  │ - 完整论辩图      │                  │
│  │ - 推理过程        │  │ - 节点+边         │                  │
│  │ - 关键证据        │  │ - 统计信息        │                  │
│  └───────────────────┘  └───────────────────┘                  │
│                                                                   │
│  ┌────────────────────────────────────────────┐                 │
│  │  results.json (批量模式)                   │                 │
│  │  - 多个claim的预测结果                     │                 │
│  │  - 准确率统计                              │                 │
│  └────────────────────────────────────────────┘                 │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件交互

### 1. Agent与LLM交互
```
Pro/Con Agent
    ↓
调用: llm_client.generate_search_queries()
    ↓
Claude API (带Prompt)
    ↓
返回: ["查询1", "查询2", ...]
    ↓
Agent继续: 调用Jina Search
```

### 2. Agent与证据池交互
```
搜索结果(Jina)
    ↓
转换为Evidence对象
    ↓
evidence_pool.add_evidence(evidence)
    ↓
自动去重+存储
    ↓
Agent从证据池筛选:
evidence_pool.get_by_credibility("High")
```

### 3. Agent与论辩图交互
```
Agent构建论证节点
    ↓
ArgumentNode(
    content="论证内容",
    evidence_ids=[...],
    priority=0.85
)
    ↓
arg_graph.add_nodes([node])
    ↓
攻击检测器扫描
    ↓
发现: node_new(0.9) vs node_old(0.7)
    ↓
创建AttackEdge(from=new, to=old)
    ↓
arg_graph.add_edges([edge])
```

## 数据流图

```
Claim输入
    ↓
┌──────────────────┐
│  第1轮           │
│  证据: 6条       │
│  节点: Pro1, Con1│
│  边: Con1→Pro1   │
└────────┬─────────┘
         ↓
┌──────────────────┐
│  第2轮           │
│  证据: +8条      │
│  节点: +Pro2,Con2│
│  边: +Con2→Pro1  │
└────────┬─────────┘
         ↓
┌──────────────────┐
│  第3轮           │
│  证据: +7条      │
│  节点: +Pro3,Con3│
│  边: +Pro3→Con2  │
└────────┬─────────┘
         ↓
    论辩图完成
    (6节点,4边)
         ↓
  Grounded Extension
  → {Con1, Con3, Pro3}
         ↓
     判决: Refuted
```

## 优先级计算流程

```
证据A (High, 权威网站)  → 1.0
证据B (Medium, 新闻)    → 0.6
证据C (Low, 论坛)       → 0.3
    ↓
组合计算:
avg = (1.0 + 0.6) / 2 = 0.8
数量加成 = 2 * 0.02 = 0.04
最终优先级 = 0.8 + 0.04 = 0.84
```

## 攻击关系判定

```
节点A (优先级0.9) vs 节点B (优先级0.6)
    ↓
检查1: 0.9 > 0.6? ✓
检查2: A和B对立立场? ✓
检查3: A的内容攻击B? ✓ (LLM判断或规则)
    ↓
创建攻击边: A → B
强度 = 0.9 - 0.6 = 0.3
```

## Grounded Extension计算

```
论辩图:
  Pro1(0.7) ← Con1(0.9)
  Pro2(0.8) ← Con2(0.85)
  Con1 ← Pro3(0.95)

迭代1:
  - Pro3无攻击者 → 接受
  
迭代2:
  - Con1被Pro3攻击,Pro3已接受 → 拒绝Con1
  - Pro1被Con1攻击,但Con1被拒绝 → 接受Pro1
  
迭代3:
  - Con2无被接受的攻击者 → 接受Con2
  - Pro2被Con2攻击,Con2已接受 → 拒绝Pro2

最终Extension: {Pro1, Pro3, Con2}
```

## 文件依赖关系

```
main.py
  ├── agents/pro_agent.py
  │     └── llm/claude_client.py
  │     └── tools/priority_calculator.py
  ├── agents/con_agent.py
  │     └── (同Pro)
  ├── agents/judge_agent.py
  │     └── reasoning/semantics.py
  ├── tools/jina_search.py
  ├── tools/attack_detector.py
  ├── core/argumentation_graph.py
  │     └── utils/models.py
  └── core/evidence_pool.py
        └── utils/models.py
```

## 异步并发设计

```python
# 并行搜索
pro_results, con_results = await asyncio.gather(
    search_engine.search_batch(pro_queries),
    search_engine.search_batch(con_queries)
)

# 顺序构建(Con看到Pro的新节点)
pro_nodes = pro_agent.construct_arguments(...)  # 先
arg_graph.add_nodes(pro_nodes)
con_nodes = con_agent.construct_arguments(...)  # 后
arg_graph.add_nodes(con_nodes)
```

## 错误处理策略

1. **API调用失败**: 返回空列表,继续运行
2. **搜索无结果**: Agent会在下一轮调整查询
3. **LLM返回格式错误**: 使用默认值或跳过
4. **优先级冲突**: 严格验证,拒绝非法攻击边

## 可扩展点

1. **新的Agent类型**: 继承`BaseAgent`(未实现,但预留接口)
2. **新的语义**: `preferred_semantics`、`stable_semantics`
3. **新的搜索引擎**: 实现相同接口即可替换Jina
4. **新的优先级算法**: 修改`priority_calculator.py`
5. **可视化UI**: 读取JSON输出,前端渲染

---

这个架构设计的核心思想:
- **模块化**: 每个组件职责单一
- **可测试**: 每个模块独立测试
- **可扩展**: 预留接口便于扩展
- **异步高效**: 并行搜索,顺序推理
- **数据驱动**: 基于形式化语义而非启发式规则
